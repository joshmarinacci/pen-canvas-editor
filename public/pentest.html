<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style type="text/css">
        canvas {
            border: 3px solid red;
        }
        canvas {
            touch-action: manipulation;
            user-select: none;
        }
        #wrapper {
            border: 5px solid red;
            /*width: 300px;*/
            /*height: 300px;*/
            overflow: scroll;
        }
    </style>
</head>
<body>
<button id="smooth">toggle smooth</button>
<div id="wrapper">
    <canvas id='canvas' width="800" height="600"></canvas>
</div>
<script type="module">
    const $ = (sel) => document.querySelector(sel)
    const on = (e,t,cb)=>e.addEventListener(t,cb)

    class Point {
        constructor(x, y) {
            this.x = x
            this.y = y
        }

        minus(pt) {
            return new Point(
                this.x - pt.x,
                this.y - pt.y
            )
        }

        plus(pt) {
            return new Point(
                this.x + pt.x,
                this.y + pt.y
            )
        }

        copy() {
            return new Point(this.x, this.y)
        }
        copyFrom(pt) {
            this.x = pt.x
            this.y = pt.y
        }
        dist(pt) {
            let dx = this.x - pt.x
            let dy = this.y - pt.y
            return Math.sqrt(dx*dx + dy*dy)
        }
        div(val) {
            return new Point(
                this.x/val,
                this.y/val
            )
        }
    }


    const canvas = document.getElementById('canvas')
    let pressed = false
    let points = []
    let prev = null
    let smooth = false
    canvas.addEventListener('pointerdown',(e)=>{
        console.log("type",e.pointerType)
        if(e.pointerType === 'touch') return
        points = []
        pressed = true
        prev = getPoint(e)
        /*
        if(e.pointerType === 'pen') {
            console.log("stopping")
            if(e.buttons > 0) {
                console.log("a button is down")
                if((e.buttons & 32)>>5 > 0) {
                    console.log("it is erase")
                }
                if((e.buttons & 1)>>0 > 0) {
                    console.log("it is draw")
                }
            }
        }*/
    })
    //canvas.addEventListener("pointercancel",(e)=>{
        //console.log("canceled")
    //})
    canvas.addEventListener('touchstart',(e)=>{
//        console.log("cancling touch?")
        if(pressed) e.preventDefault()
    })
    function getPoint(e) {
        const rect = e.target.getBoundingClientRect()
        let pt = new Point(
            e.clientX - rect.left,
            e.clientY - rect.top
        )
        const scale = Math.pow(2,0)*1
        pt = pt.div(scale)
        return pt
    }

    function recordEvent(e) {
        e.getCoalescedEvents().forEach(e => {
            points.push({
                x:e.clientX,
                y:e.clientY,
                pointerType:e.pointerType,
                tiltX:e.tiltX,
                tiltY:e.tiltY,
                pressure:e.pressure,
            })
        })
    }

    canvas.addEventListener('pointermove',(e)=>{
        if(!pressed) return
        e.preventDefault()
        recordEvent(e)
        const ctx = canvas.getContext('2d')
        ctx.fillStyle = 'black'
        ctx.lineWidth = 1
        ctx.strokeStyle = 'black'
        ctx.beginPath()
        ctx.moveTo(prev.x,prev.y)
        if(true) {
            e.getCoalescedEvents().forEach(e => {
                const pt = getPoint(e)
                ctx.lineTo(pt.x, pt.y)
                prev = pt
            })
        } else {
            const pt = getPoint(e)
            ctx.lineTo(pt.x, pt.y)
            prev = pt
        }
        ctx.stroke()
    })

    function dumpEvents(e) {
        console.log(JSON.stringify(points,null,'   '))
    }

    function redraw() {
        const ctx = canvas.getContext('2d')
        ctx.save()
        ctx.fillStyle = 'red'
        ctx.fillRect(0,0,canvas.width,canvas.height)
        ctx.lineWidth = 1
        ctx.strokeStyle = 'black'
        ctx.beginPath()
        for(let i=0; i<points.length; i++) {
            let pt = points[i]
            if(i===0) {
                ctx.moveTo(pt.x,pt.y)
            } else {
                ctx.lineTo(pt.x,pt.y)
            }
        }
        ctx.stroke()
        ctx.restore()
    }

    canvas.addEventListener('pointerup',(e) => {
        console.log("up")
        pressed = false
        redraw()
        dumpEvents(e)
    })

    on($("#smooth"),'click',()=>{
        smooth = !smooth
        console.log("smooth = ", smooth)
    })
</script>
</body>
</html>
